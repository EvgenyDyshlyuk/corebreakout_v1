

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Creating Datasets &mdash; CoreBreakout 0.3 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Building Mask R-CNN Models" href="model_building.html" />
    <link rel="prev" title="Welcome to CoreBreakout’s documentation!" href="index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> CoreBreakout
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Usage Documentation:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Creating <code class="docutils literal notranslate"><span class="pre">Datasets</span></code></a><ul>
<li class="toctree-l2"><a class="reference internal" href="#using-labelme">Using <code class="docutils literal notranslate"><span class="pre">labelme</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#inspect-our-annotations">Inspect Our Annotations</a></li>
<li class="toctree-l2"><a class="reference internal" href="#how-to-name-things">How to Name Things</a></li>
<li class="toctree-l2"><a class="reference internal" href="#removing-imagedata">Removing <code class="docutils literal notranslate"><span class="pre">imageData</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#summary-of-guidelines">Summary of Guidelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="#corebreakout-datasets-polygondataset"><code class="docutils literal notranslate"><span class="pre">corebreakout.datasets.PolygonDataset</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="#usage">Usage</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#subclassing-mrcnn-utils-dataset">Subclassing <code class="docutils literal notranslate"><span class="pre">mrcnn.utils.Dataset</span></code></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="model_building.html">Building Mask R-CNN Models</a><ul>
<li class="toctree-l2"><a class="reference internal" href="model_building.html#mrcnn-model-configuration"><code class="docutils literal notranslate"><span class="pre">mrcnn</span></code> Model Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="model_building.html#model-training">Model Training</a></li>
<li class="toctree-l2"><a class="reference internal" href="model_building.html#model-selection">Model Selection</a></li>
<li class="toctree-l2"><a class="reference internal" href="model_building.html#using-a-model">Using a Model</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="layout_parameters.html">Layout Parameters</a><ul>
<li class="toctree-l2"><a class="reference internal" href="layout_parameters.html#order-and-orientation"><code class="docutils literal notranslate"><span class="pre">order</span></code> and <code class="docutils literal notranslate"><span class="pre">orientation</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="layout_parameters.html#col-height"><code class="docutils literal notranslate"><span class="pre">col_height</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="layout_parameters.html#col-class"><code class="docutils literal notranslate"><span class="pre">col_class</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="layout_parameters.html#endpts"><code class="docutils literal notranslate"><span class="pre">endpts</span></code></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="scripts_reference.html">Scripts Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="scripts_reference.html#train-mrcnn-model-py"><code class="docutils literal notranslate"><span class="pre">train_mrcnn_model.py</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="scripts_reference.html#get-ocr-depths-py"><code class="docutils literal notranslate"><span class="pre">get_ocr_depths.py</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="scripts_reference.html#process-directory-py"><code class="docutils literal notranslate"><span class="pre">process_directory.py</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="scripts_reference.html#prune-imagedata-py"><code class="docutils literal notranslate"><span class="pre">prune_imageData.py</span></code></a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">CoreBreakout</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Creating <code class="docutils literal notranslate"><span class="pre">Datasets</span></code></li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/creating_datasets.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="creating-datasets">
<span id="id1"></span><h1>Creating <code class="docutils literal notranslate"><span class="pre">Datasets</span></code><a class="headerlink" href="#creating-datasets" title="Permalink to this headline">¶</a></h1>
<div class="section" id="using-labelme">
<h2>Using <code class="docutils literal notranslate"><span class="pre">labelme</span></code><a class="headerlink" href="#using-labelme" title="Permalink to this headline">¶</a></h2>
<p>The recommended way to add a new set of labeled training images is to annotate them using <a class="reference external" href="https://github.com/wkentaro/labelme">wkentaro/labelme</a>. The <code class="docutils literal notranslate"><span class="pre">labelme</span></code> GUI allows the user to draw any number of labeled polygons on an image, and saves the labels and coordinates in a JSON annotation file.</p>
<p>You can easily install <code class="docutils literal notranslate"><span class="pre">labelme</span></code> with <code class="docutils literal notranslate"><span class="pre">pip</span></code>, and then open our small test dataset:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ pip install labelme
$ labelme tests/data/two_image_dataset
</pre></div>
</div>
<p>This should open a window that looks like this:</p>
<p><img alt="image0" src="_images/labelme1.png" /></p>
<p>New polygons can be drawn by clicking <code class="docutils literal notranslate"><span class="pre">Create</span> <span class="pre">Polygons</span></code> and then clicking points on the image to add vertices. When you get back around to the starting vertex to close the loop of points and create a polygon, <code class="docutils literal notranslate"><span class="pre">labelme</span></code> will ask you to assign it a text label.</p>
<p>Unique text labels are aggregated on the right side, and the individual polygons shown in the image are colored and listed with their assigned labels. They happen to be the same in this example, but there could be more labels in the <code class="docutils literal notranslate"><span class="pre">Label</span> <span class="pre">List</span></code> than polygons in the <code class="docutils literal notranslate"><span class="pre">Polygon</span> <span class="pre">Labels</span></code> list for any given image in the directory.</p>
<p>When you finish adding polygons, click the <code class="docutils literal notranslate"><span class="pre">Save</span></code> button to export the annotations as a <code class="docutils literal notranslate"><span class="pre">.json</span></code> file, which by default will save to the current directory.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">File</span> <span class="pre">List</span></code> shows images in the currently directory, with the checkbox indicating whether an annotation has been saved for that file yet. You can use the <code class="docutils literal notranslate"><span class="pre">Next</span> <span class="pre">Image</span></code> and <code class="docutils literal notranslate"><span class="pre">Previous</span> <span class="pre">Image</span></code> buttons to traverse through the images (and corresponding annotations) in the directory.</p>
</div>
<div class="section" id="inspect-our-annotations">
<h2>Inspect Our Annotations<a class="headerlink" href="#inspect-our-annotations" title="Permalink to this headline">¶</a></h2>
<p>For a more hands-on exploration of annotation structure and the <code class="docutils literal notranslate"><span class="pre">Dataset</span></code> API, see <a class="reference external" href="https://github.com/rgmyr/corebreakout/blob/master/notebooks/inspect_dataset.ipynb">notebooks/inspect_dataset.py</a></p>
</div>
<div class="section" id="how-to-name-things">
<h2>How to Name Things<a class="headerlink" href="#how-to-name-things" title="Permalink to this headline">¶</a></h2>
<p>As you can see above, our text labels for individual objects have the form <code class="docutils literal notranslate"><span class="pre">&lt;class&gt;&lt;number&gt;</span></code>. The <code class="docutils literal notranslate"><span class="pre">class</span></code> refers to a general object type, the <code class="docutils literal notranslate"><span class="pre">number</span></code> differentiates between individual <cite>instances</cite> of that class within an image. This isn’t the only possible naming scheme, but it’s the one you should use if you want your annotations to be compatible with our <code class="docutils literal notranslate"><span class="pre">PolygonDataset</span></code> implementation.</p>
<p>In our data, we use two classes, <strong>col</strong> and <strong>tray</strong>, to label two different types of objects:</p>
<ul class="simple">
<li><p><strong>col</strong> is for <cite>columns</cite> of core material – the individual objects that we want to segment, crop, and stack on top of each other.</p></li>
<li><p><strong>tray</strong> is for empty trays, which for our data are the most reliable “measuring stick” to use for defining the “top” and “base” positions of columns within an image</p></li>
</ul>
<p>The first type of object is required – the whole purpose of this workflow is to segment core columns, so you will need to at least label those.</p>
<p>The second type of object is optional – using another object (empty tray, measuring stick, etc.) to define top and base positions of columns is <cite>one</cite> option for the <code class="docutils literal notranslate"><span class="pre">endpts</span></code> setting in <a class="reference internal" href="layout_parameters.html#layout-parameters"><span class="std std-ref">Layout Parameters</span></a>, but there are others which do not require the existence of any objects other than core columns.</p>
<p>If you’re making your own dataset, your class names can be whatever you want them to be. You just need at least some name for core columns, and to keep general consistency between:</p>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">PolygonDataset</span></code> (s) you train your model with, which use the annotations you saved.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">kwargs</span></code> you provide when instantiating a <code class="docutils literal notranslate"><span class="pre">CoreSegmenter</span></code>. Namely:</p>
<ul>
<li><p>The <code class="docutils literal notranslate"><span class="pre">classes</span></code> argument (it should be the same as for <code class="docutils literal notranslate"><span class="pre">PolygonDataset</span></code>)</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">col_class</span></code> (and possibly <code class="docutils literal notranslate"><span class="pre">endpts</span></code>) fields of the <code class="docutils literal notranslate"><span class="pre">layout_params</span></code></p></li>
</ul>
</li>
</ul>
<p>If you decide to use different class names (or layout parameters), we’d recommend changing the <code class="docutils literal notranslate"><span class="pre">CLASSES</span></code> and <code class="docutils literal notranslate"><span class="pre">LAYOUT_PARAMS</span></code> in <a class="reference external" href="https://github.com/rgmyr/corebreakout/blob/master/corebreakout/defaults.py">defaults.py</a> so that you don’t have to specify them as often.</p>
</div>
<div class="section" id="removing-imagedata">
<h2>Removing <code class="docutils literal notranslate"><span class="pre">imageData</span></code><a class="headerlink" href="#removing-imagedata" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">labelme</span></code> saves a field called <code class="docutils literal notranslate"><span class="pre">imageData</span></code> which encodes the entire image as a string, consuming quite a bit of unnecessary memory. Our <code class="docutils literal notranslate"><span class="pre">PolygonDataset</span></code> class doesn’t make use of this field, and we’ve provided a script to delete it from all JSON files below a root <code class="docutils literal notranslate"><span class="pre">path</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python scripts/prune_imageData.py &lt;path&gt;
</pre></div>
</div>
</div>
<div class="section" id="summary-of-guidelines">
<h2>Summary of Guidelines<a class="headerlink" href="#summary-of-guidelines" title="Permalink to this headline">¶</a></h2>
<p>To be able to use the built-in <code class="docutils literal notranslate"><span class="pre">corebreakout.datasets.PolygonDataset</span></code> class with your training data, you want to adhere to these guidelines:</p>
<ul class="simple">
<li><p>Save <code class="docutils literal notranslate"><span class="pre">&lt;fname&gt;.json</span></code> annotations in a flat directory with
corresponding <code class="docutils literal notranslate"><span class="pre">&lt;fname&gt;.jpeg</span></code> files (this is <code class="docutils literal notranslate"><span class="pre">labelme</span></code>’s default
behavior)</p></li>
<li><p>You may label any number of classes. You will have to supply a list
of these classes to the <code class="docutils literal notranslate"><span class="pre">PolygonDataset</span></code> and <code class="docutils literal notranslate"><span class="pre">CoreSegmenter</span></code> constructors, or modify
<code class="docutils literal notranslate"><span class="pre">defaults.CLASSES</span></code>.</p>
<ul>
<li><p>At a minimum, you will want some class name to represent columns of core. We call ours <code class="docutils literal notranslate"><span class="pre">'col'</span></code>, but it doesn’t matter what you want to call it if you’re using your own data.</p></li>
<li><p>You may also create a class (<em>e.g.</em>, <code class="docutils literal notranslate"><span class="pre">'tray'</span></code>) for any objects that consistently demarcate the top and base positions of core columns better than the columns themselves.</p></li>
</ul>
</li>
<li><p>Different instances of the same class should begin with the class
name and be differentiated afterward (<em>e.g.</em>, <code class="docutils literal notranslate"><span class="pre">col1,</span> <span class="pre">col2,</span> <span class="pre">col3</span></code>)</p>
<ul>
<li><p>The corollary is that no class name can be a substring of any
other class name (<em>e.g.</em>, <code class="docutils literal notranslate"><span class="pre">col,</span> <span class="pre">col_tray</span></code> would not be allowed)</p></li>
<li><p>Multiple polygons may belong to a single instance (for example, if there’s a large gap in the middle of a column)</p></li>
</ul>
</li>
<li><p>After annotating images, split into sibling <code class="docutils literal notranslate"><span class="pre">'train'</span></code> and
<code class="docutils literal notranslate"><span class="pre">'test'</span></code> subdirectories</p></li>
</ul>
<p><strong>Note:</strong> We’ve found that the point of diminishing returns happens somewhere in the range of 20-30 training images, which probably corresponds to 30-50 column instances for this dataset. YMMV.</p>
<p>After compiling the annotations, you may wish to modify <code class="docutils literal notranslate"><span class="pre">defaults.DATASET_DIR</span></code> to avoid need to explicitly specify the data location.</p>
</div>
<div class="section" id="corebreakout-datasets-polygondataset">
<h2><code class="docutils literal notranslate"><span class="pre">corebreakout.datasets.PolygonDataset</span></code><a class="headerlink" href="#corebreakout-datasets-polygondataset" title="Permalink to this headline">¶</a></h2>
<p>This is a subclass of <code class="docutils literal notranslate"><span class="pre">mrcnn.utils.Dataset</span></code> for instance segmentation
annotations in the default JSON format of
<a class="reference external" href="https://github.com/wkentaro/labelme">wkentaro/labelme</a>.</p>
<div class="section" id="usage">
<h3>Usage<a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">corebreakout.datasets</span> <span class="k">import</span> <span class="n">PolygonDataset</span>

<span class="n">data_dir</span> <span class="o">=</span> <span class="n">defaults</span><span class="o">.</span><span class="n">DEFAULT_DATA_DIR</span>    <span class="c1"># parent of any separate annotation data directories</span>
<span class="n">subset</span> <span class="o">=</span> <span class="s1">&#39;train&#39;</span>                        <span class="c1"># which subdirectory to read from</span>

<span class="n">dataset</span> <span class="o">=</span> <span class="n">PolygonDataset</span><span class="p">(</span><span class="n">classes</span><span class="o">=</span><span class="n">defaults</span><span class="o">.</span><span class="n">DEFAULT_CLASSES</span><span class="p">)</span>

<span class="c1"># Collect all of the requied ID + path information</span>
<span class="n">dataset</span><span class="o">.</span><span class="n">collect_annotated_images</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">subset</span><span class="p">)</span>

<span class="c1"># Set all of the attrs required for use</span>
<span class="n">dataset</span><span class="o">.</span><span class="n">prepare</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
</pre></div>
</div>
<p>Two <code class="docutils literal notranslate"><span class="pre">Dataset</span></code> objects (train, test) are required in calls to <code class="docutils literal notranslate"><span class="pre">model.train(...)</span></code>, which is why we split them into separate directories.</p>
</div>
</div>
<div class="section" id="subclassing-mrcnn-utils-dataset">
<h2>Subclassing <code class="docutils literal notranslate"><span class="pre">mrcnn.utils.Dataset</span></code><a class="headerlink" href="#subclassing-mrcnn-utils-dataset" title="Permalink to this headline">¶</a></h2>
<p>If you want to use a different annotation format, you can inherit from
the base <code class="docutils literal notranslate"><span class="pre">mrcnn.utils.Dataset</span></code> class.</p>
<p>You will need to write some user-called method to collect file
information:</p>
<ul class="simple">
<li><p><em>e.g.</em>, <code class="docutils literal notranslate"><span class="pre">collect_annotated_images(data_dir,</span> <span class="pre">subset)</span></code>: Register <code class="docutils literal notranslate"><span class="pre">image_id</span></code>, <code class="docutils literal notranslate"><span class="pre">path</span></code>, and <code class="docutils literal notranslate"><span class="pre">ann_path</span></code> for each (image, annotation) file pair in <code class="docutils literal notranslate"><span class="pre">&lt;data_dir&gt;/&lt;subset&gt;</span></code> directory.</p></li>
</ul>
<p>And then override at least these two methods:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">load_mask(image_id)</span></code>: Given an <code class="docutils literal notranslate"><span class="pre">image_id</span></code>, load (and compute, if necessary) the corresponding mask. For an with <code class="docutils literal notranslate"><span class="pre">N</span></code> objects (not including the background), the return value from this function should be <code class="docutils literal notranslate"><span class="pre">(mask,</span> <span class="pre">class_ids)</span></code>, where <code class="docutils literal notranslate"><span class="pre">mask</span></code> is boolean array of shape <code class="docutils literal notranslate"><span class="pre">(H,W,N)</span></code> and <code class="docutils literal notranslate"><span class="pre">class_ids</span></code> is a 1D integer array of size <code class="docutils literal notranslate"><span class="pre">N</span></code> with one <code class="docutils literal notranslate"><span class="pre">class_id</span></code> for each channel in <code class="docutils literal notranslate"><span class="pre">mask</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">image_reference(image_id)</span></code>: Return the path of an image, a link to it, or some other unique property to help in looking it up or debugging it.</p></li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="model_building.html" class="btn btn-neutral float-right" title="Building Mask R-CNN Models" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="index.html" class="btn btn-neutral float-left" title="Welcome to CoreBreakout’s documentation!" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Ross Meyer, Thomas Martin, Zane Jobe

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>